name: Build DXVK Adreno 840 Optimized Nightly

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout DXVK
      uses: actions/checkout@v4
      with:
        repository: doitsujin/dxvk
        path: dxvk
        submodules: recursive
        fetch-depth: 0

    - name: Checkout DXVK GPLAsync
      run: git clone https://gitlab.com/Ph42oN/dxvk-gplasync.git dxvk-gplasync

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y meson ninja-build mingw-w64 glslang-tools wine python3

    - name: Apply GPLAsync Patch
      run: |
        cd dxvk
        # Explicitly use the master patch for the master branch
        PATCH_FILE="../dxvk-gplasync/patches/dxvk-gplasync-master.patch"
        echo "Applying patch: $PATCH_FILE"
        git apply "$PATCH_FILE"

    - name: Apply Adreno 840 Optimizations
      run: |
        cd dxvk
        
        # 1. Force Enable Descriptor Buffers
        cat <<'EOF' > opt1.py
        import sys
        path = "src/dxvk/dxvk_device.h"
        with open(path, "r") as f: content = f.read()
        old = "return m_features.extDescriptorBuffer.descriptorBuffer && !canUseDescriptorHeap();"
        new = "if (m_adapter->matchesDriver(VK_DRIVER_ID_MESA_TURNIP)) return m_features.extDescriptorBuffer.descriptorBuffer && !canUseDescriptorHeap();\n      return m_features.extDescriptorBuffer.descriptorBuffer && !canUseDescriptorHeap();"
        content = content.replace(old, new, 1)
        with open(path, "w") as f: f.write(content)
        EOF
        python3 opt1.py

        # 2. Oryon-Aware Thread Tuning
        cat <<'EOF' > opt2.py
        import sys
        path = "src/dxvk/dxvk_pipemanager.cpp"
        with open(path, "r") as f: content = f.read()
        old = "uint32_t workerCount = dxvk::thread::hardware_concurrency();"
        new = old + "\n      if (m_device->adapter()->matchesDriver(VK_DRIVER_ID_MESA_TURNIP)) workerCount = 8;"
        content = content.replace(old, new)
        with open(path, "w") as f: f.write(content)
        EOF
        python3 opt2.py

        # 3. Disable Pipeline Lifetime Tracking
        cat <<'EOF' > opt3.py
        import sys
        path = "src/dxvk/dxvk_device.cpp"
        with open(path, "r") as f: content = f.read()
        old = "if (m_adapter->matchesDriver(VK_DRIVER_ID_MESA_RADV_KHR))"
        new = "if (m_adapter->matchesDriver(VK_DRIVER_ID_MESA_RADV_KHR) || m_adapter->matchesDriver(VK_DRIVER_ID_MESA_TURNIP))"
        content = content.replace(old, new)
        with open(path, "w") as f: f.write(content)
        EOF
        python3 opt3.py

        # 4. UMA-Specific Memory Budget Expansion
        cat <<'EOF' > opt4.py
        import sys
        path = "src/dxvk/dxvk_device.cpp"
        with open(path, "r") as f: content = f.read()
        old = "m_shaderCache = DxvkShaderCache::getInstance();"
        new = old + "\n\n    if (m_adapter->matchesDriver(VK_DRIVER_ID_MESA_TURNIP) && !m_options.maxMemoryBudget)\n      m_options.maxMemoryBudget = 8192ull << 20u;"
        content = content.replace(old, new)
        with open(path, "w") as f: f.write(content)
        EOF
        python3 opt4.py

    - name: Build DXVK
      run: |
        cd dxvk
        ./package-release.sh master ../dxvk-built --no-package

    - name: Generate Logs
      run: |
        cd dxvk
        git log --since="24 hours ago" > ../changelog.txt
        echo "Adreno 840 Optimizations applied: Descriptor Buffers, 8 Worker Threads, No Pipeline Tracking, 8GB Budget." > ../modified-optimizations.txt

    - name: Prepare and Package
      run: |
        mkdir -p packaging/system32 packaging/syswow64
        cp dxvk-built/dxvk-master/x64/*.dll packaging/system32/
        cp dxvk-built/dxvk-master/x32/*.dll packaging/syswow64/
        
        # Determine Version
        DXVK_VER=$(grep -oP "\bversion : '\K[^']+" dxvk/meson.build | head -n 1)
        if [ -z "$DXVK_VER" ]; then DXVK_VER="nightly"; fi
        
        # Create profile.json and perform substitution using Python
        cat <<'EOF' > package_info.py
        import sys
        import os

        dxvk_ver = os.environ.get("DXVK_VER", "nightly")
        
        profile = {
          "type": "DXVK",
          "versionName": f"{dxvk_ver}-gplasync-adreno840",
          "versionCode": 2,
          "description": f"dxvk {dxvk_ver}-gplasync with Adreno 840 optimizations",
          "author": "MaxsTechReview",
          "files": [
            { "source": "system32/d3d9.dll", "target": "${system32}/d3d9.dll" },
            { "source": "system32/d3d10core.dll", "target": "${system32}/d3d10core.dll" },
            { "source": "system32/d3d11.dll", "target": "${system32}/d3d11.dll" },
            { "source": "system32/dxgi.dll", "target": "${system32}/dxgi.dll" },
            { "source": "syswow64/d3d9.dll", "target": "${syswow64}/d3d9.dll" },
            { "source": "syswow64/d3d10core.dll", "target": "${syswow64}/d3d10core.dll" },
            { "source": "syswow64/d3d11.dll", "target": "${syswow64}/d3d11.dll" },
            { "source": "syswow64/dxgi.dll", "target": "${syswow64}/dxgi.dll" }
          ]
        }

        import json
        with open("packaging/profile.json", "w") as f:
            json.dump(profile, f, indent=2)
        EOF
        
        export DXVK_VER
        python3 package_info.py
        
        # Create WCP package (Winlator Container Package)
        tar -cJf dxvk-${DXVK_VER}-gplasync-adreno840.wcp -C packaging .

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dxvk-adreno840-build
        path: |
          *.wcp
          changelog.txt
          modified-optimizations.txt
